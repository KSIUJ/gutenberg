name: Gutenberg

on: [push]

jobs:
  test_django:
    runs-on: ubuntu-latest
    env:
      DJANGO_SETTINGS_MODULE: gutenberg.settings.test_settings
    steps:
    - uses: actions/checkout@v5
      with:
        sparse-checkout: |
          backend

    - name: "Set up Python"
      uses: actions/setup-python@v5
      with:
        python-version-file: 'backend/pyproject.toml'

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        version: "0.8.2"

    - name: Configure venv and install dependencies
      working-directory: backend
      run: uv sync

    - name: Run migrations
      working-directory: backend
      run: uv run manage.py migrate

    - name: Run tests
      working-directory: backend
      run: uv run manage.py test

  test_webapp:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22.x, lts/*, latest]
    steps:
    - uses: actions/checkout@v5
      with:
        sparse-checkout: |
          .github
          webapp

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        run_install: false
        package_json_file: 'webapp/package.json'

    - name: Use Node.js version ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'
        cache-dependency-path: 'webapp/pnpm-lock.yaml'

    - name: Install dependencies
      working-directory: webapp
      run: pnpm install --frozen-lockfile

    - name: Build
      working-directory: webapp
      run: pnpm run build

    - name: Typecheck
      working-directory: webapp
      run: pnpm run typecheck

    - name: Lint
      working-directory: webapp
      run: pnpm run lint
